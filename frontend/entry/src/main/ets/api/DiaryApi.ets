import http from '@ohos.net.http'
import { Diary } from '../model/Diary'
import { DiaryDto } from '../model/DiaryDto'
import { R } from '../model/R' // ğŸ’¡ è®°å¾—å¼•å…¥æˆ‘ä»¬å®šä¹‰çš„ R æ¥å£

const BASE_URL = 'http://10.0.2.2:8080/api/diary'

function request<T>(url: string, options: http.HttpRequestOptions): Promise<T | null> {
  return new Promise<T | null>((resolve, reject) => {
    console.log('ğŸ“¤ HTTP Request:', url, options)
    const httpRequest = http.createHttp()

    httpRequest.request(url, options, (err: Error, data: http.HttpResponse) => {
      httpRequest.destroy()

      if (err) {
        console.error('âŒ HTTP Error:', err)
        reject(err)
        return
      }

      const resultString = data.result as string;
      console.log('ğŸ“¥ HTTP Response:', resultString)

      if (!resultString || resultString.trim() === "") {
        resolve(null)
        return
      }

      // ğŸ’¡ æ ¸å¿ƒä¿®æ”¹ç‚¹ï¼šé€‚é…åç«¯çš„ R<T> ç»“æ„
      try {
        // å…ˆè§£æä¸ºç»Ÿä¸€å“åº”æ ¼å¼ R<T>
        const response: R<T> = JSON.parse(resultString) as R<T>

        // åˆ¤æ–­åç«¯ä¸šåŠ¡çŠ¶æ€ç 
        if (response.code === 200) {
          // ğŸ’¡ ä¸šåŠ¡æˆåŠŸï¼Œåªè¿”å› data éƒ¨åˆ†
          resolve(response.data)
        } else {
          // ğŸ’¡ ä¸šåŠ¡å¤±è´¥ï¼ˆå¦‚åç«¯è¿”å› R.errorï¼‰ï¼ŒæŠ›å‡ºåç«¯ç»™çš„æ¶ˆæ¯
          reject(new Error(response.msg || 'ä¸šåŠ¡è¯·æ±‚å¤±è´¥'))
        }
      } catch (e) {
        console.error('âŒ JSON Parse Error:', e)
        reject(new Error("æ•°æ®æ ¼å¼é”™è¯¯"))
      }
    })
  })
}

export class DiaryApi {
  // è·å–æŒ‡å®šç”¨æˆ·çš„æ—¥è®°åˆ—è¡¨
  static async getList(userId: number): Promise<Diary[]> {
    const res = await request<Diary[]>(`${BASE_URL}/user/${userId}`, {
      method: http.RequestMethod.GET
    })
    return res ?? []
  }

  // è·å–è¯¦æƒ…
  static async detail(id: number): Promise<Diary | null> {
    return request<Diary>(`${BASE_URL}/${id}`, {
      method: http.RequestMethod.GET
    })
  }

  // åˆ›å»ºæ—¥è®°
  static async create(diary: DiaryDto): Promise<Diary | null> {
    return request<Diary>(BASE_URL, {
      method: http.RequestMethod.POST,
      header: { 'Content-Type': 'application/json' },
      extraData: JSON.stringify(diary)
    })
  }

  // æ›´æ–°æ—¥è®°
  static async update(id: number, diary: DiaryDto): Promise<Diary | null> {
    return request<Diary>(`${BASE_URL}/${id}`, {
      method: http.RequestMethod.PUT,
      header: { 'Content-Type': 'application/json' },
      extraData: JSON.stringify(diary)
    })
  }

  // åˆ é™¤æ—¥è®°
  static async delete(id: number): Promise<boolean> {
    // åç«¯ç°åœ¨è¿”å›çš„æ˜¯ R<String>ï¼Œæ‰€ä»¥æ³›å‹ä¼  string
    const res = await request<string>(`${BASE_URL}/${id}`, {
      method: http.RequestMethod.DELETE
    })
    return res !== null
  }
}