import http from '@ohos.net.http'
import { User } from '../model/User'
import { UserDto } from '../model/UserDto'
import { R } from '../model/R' // ğŸ’¡ å¼•å…¥ç»Ÿä¸€è¿”å›æ¨¡å‹æ¥å£
import fs from '@ohos.file.fs';
import { buffer } from '@kit.ArkTS';

const BASE_URL = 'http://10.0.2.2:8080/api/user'

// åŸºç¡€è¯·æ±‚å·¥å…·ï¼šé€‚é…åç«¯ R<T> åè®®
function request<T>(url: string, options: http.HttpRequestOptions): Promise<T | null> {
  return new Promise<T | null>((resolve, reject) => {
    const httpRequest = http.createHttp()

    httpRequest.request(url, options, (err: Error, data: http.HttpResponse) => {
      httpRequest.destroy()
      if (err) {
        reject(err)
        return
      }

      const resultString = data.result as string
      if (!resultString || resultString.trim() === "") {
        resolve(null)
        return
      }

      try {
        // ğŸ’¡ æ ¸å¿ƒé€»è¾‘ï¼šå…ˆè§£æä¸º R<T>
        const response: R<T> = JSON.parse(resultString) as R<T>

        // åˆ¤æ–­ä¸šåŠ¡çŠ¶æ€ç 
        if (response.code === 200) {
          resolve(response.data) // æˆåŠŸï¼šè¿”å›å…·ä½“ä¸šåŠ¡æ•°æ®
        } else {
          // å¤±è´¥ï¼šæŠŠåç«¯ R.error(msg) é‡Œçš„æç¤ºè¯­æŠ›å‡º
          reject(new Error(response.msg))
        }
      } catch (e) {
        reject(new Error("USER_JSON_PARSE_ERROR"))
      }
    })
  })
}

export class UserApi {

  // å‘é€éªŒè¯ç 
  static async sendEmailCode(email: string): Promise<boolean> {
    // åç«¯è¿”å› R<String>ï¼Œæ³›å‹ä¼  string
    const res = await request<string>(`${BASE_URL}/sendCode`, {
      method: http.RequestMethod.POST,
      header: { 'Content-Type': 'application/json' },
      extraData: JSON.stringify({ email: email })
    })
    return res !== null;
  }

  // æ³¨å†Œ
  static async register(user: User, code: string): Promise<User | null> {
    return request<User>(`${BASE_URL}/register`, {
      method: http.RequestMethod.POST,
      header: { 'Content-Type': 'application/json' },
      extraData: JSON.stringify({
        username: user.username,
        email: user.email,
        password: user.password,
        code: code
      })
    })
  }

  // ç™»å½•
  static async login(account: string, pass: string): Promise<User | null> {
    return request<User>(`${BASE_URL}/login`, {
      method: http.RequestMethod.POST,
      header: { 'Content-Type': 'application/json' },
      extraData: JSON.stringify({
        "account": account,
        "password": pass
      })
    })
  }

  // ä¿®æ”¹èµ„æ–™
  static async update(id: number, userDto: UserDto): Promise<User | null> {
    return request<User>(`${BASE_URL}/${id}`, {
      method: http.RequestMethod.PUT,
      header: { 'Content-Type': 'application/json' },
      extraData: JSON.stringify(userDto)
    })
  }

  // ğŸ’¡ ä¿®å¤ï¼šåˆå¹¶å¹¶æ¸…ç†åŸæœ‰çš„ä¸¤ä¸ª updatePasswordï¼Œæ¶ˆé™¤ any
  static async updatePassword(userId: number, oldPass: string, newPass: string): Promise<boolean> {
    const res = await request<string>(`${BASE_URL}/updatePassword`, {
      method: http.RequestMethod.POST,
      header: { 'Content-Type': 'application/json' },
      extraData: JSON.stringify({
        userId: userId,
        oldPass: oldPass,
        newPass: newPass
      })
    })
    return res !== null;
  }

  // åˆ é™¤/æ³¨é”€
  static async delete(id: number): Promise<boolean> {
    const res = await request<string>(`${BASE_URL}/${id}`, {
      method: http.RequestMethod.DELETE
    })
    return res !== null
  }

  static async uploadAvatar(uri: string): Promise<string | null> {
    // 1. è¯»å–æ–‡ä»¶å¹¶è½¬ä¸º Base64
    let file = fs.openSync(uri, fs.OpenMode.READ_ONLY);
    let stat = fs.statSync(file.fd);
    let buf = new ArrayBuffer(stat.size);
    fs.readSync(file.fd, buf);
    fs.closeSync(file);

    // å°† ArrayBuffer è½¬ä¸º Base64 å­—ç¬¦ä¸²
    let base64Str = buffer.from(buf).toString('base64');

    // 2. å¤ç”¨ä½ ç°æœ‰çš„ request å·¥å…·å‡½æ•°
    // è¿™é‡Œçš„ T ä¼  stringï¼Œå› ä¸ºåç«¯ R<String> è¿”å›çš„æ˜¯ URL å­—ç¬¦ä¸²
    return request<string>(`${BASE_URL}/upload-avatar-base64`, {
      method: http.RequestMethod.POST,
      header: { 'Content-Type': 'application/json' },
      // å°† base64 æ”¾åœ¨å¯¹è±¡é‡Œå‘è¿‡å»
      extraData: JSON.stringify({
        "image": base64Str
      })
    });
  }

}