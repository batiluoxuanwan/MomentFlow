import { User } from "../model/User"
import { promptAction } from "@kit.ArkUI"
import { AiApi } from "../api/AIApi"
import { Diary } from "../model/Diary"


@Component
export struct AnalysisPage {
  @State aiContent: string = 'ç‚¹å‡»åˆ†æï¼Œè®©æˆ‘é€šè¿‡æ—¥è®°è¯»æ‡‚ä½ çš„å¿ƒæƒ…...'
  @State isAnalyzing: boolean = false
  @StorageProp('user') user: User | null = null
  @StorageProp('diaries') diaries: Diary[] = []
  @State positiveWidth: string = '33%'
  @State neutralWidth: string = '33%'
  @State negativeWidth: string = '34%'

  updateMoodChart() {
    if (this.diaries.length === 0) return

    let posCount = 0
    let neuCount = 0
    let negCount = 0

    // å®šä¹‰åˆ†ç±»é€»è¾‘
    const positiveMoods = ['ğŸ”‹ å……æ»¡åŠ¨åŠ›', 'âœ¨ ç¡®å¹¸æ—¶åˆ»', 'ğŸ¤ å½’å±æ„Ÿ', 'ğŸµ å›ç”˜é‡Šç„¶']
    const neutralMoods = ['â˜ï¸ å¹³æ·¡æ”¾ç©º', 'ğŸ§Š æƒ…æ„Ÿéš”ç¦»', 'ğŸ§­ è¿·æƒ˜å¯»ç´¢','ğŸ•¯ï¸ å­¤ç‹¬äº«å—']
    // å…¶ä½™çš„å½’ä¸ºå‹åŠ›

    this.diaries.forEach(d => {
      if (positiveMoods.includes(d.mood)) posCount++
      else if (neutralMoods.includes(d.mood)) neuCount++
      else negCount++
    })

    const total = this.diaries.length
    // è®¡ç®—ç™¾åˆ†æ¯”å¹¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²
    this.positiveWidth = ((posCount / total) * 100).toFixed(0) + '%'
    this.neutralWidth = ((neuCount / total) * 100).toFixed(0) + '%'
    this.negativeWidth = ((negCount / total) * 100).toFixed(0) + '%'
  }

  build() {
    Column() {
      // --- å›ºå®šåŒºåŸŸï¼šæ ‡é¢˜ ---
      Text('æƒ…ç»ªç©ºé—´').fontSize(24).fontWeight(FontWeight.Bold).margin({ top: 20, bottom: 10 })
        .onVisibleAreaChange([0.0, 1.0], (isVisible: boolean, currentRatio: number) => {
          if (isVisible && currentRatio >= 1.0) {
            console.info('æƒ…ç»ªç©ºé—´å¯è§ï¼Œæ‰§è¡Œæ›´æ–°')
            this.updateMoodChart()
          }
        })

      // --- å›ºå®šåŒºåŸŸï¼šä¼˜åŒ–åçš„ç»Ÿè®¡å›¾å¡ç‰‡ ---
      Column() {
        Row() {
          Text('æœ¬å‘¨æƒ…ç»ªåº•è‰²').fontSize(15).fontWeight(FontWeight.Medium)
          Blank()
          Text('è¿‘7å¤©è®°å½•').fontSize(12).fontColor('#999')
        }.width('100%').margin({ bottom: 15 })

        Row() {
          // 1. ç§¯æ - ç»¿è‰²ï¼ˆå·¦ä¾§åœ†è§’ï¼‰
          Rect()
            .width(this.positiveWidth)
            .height(14) // ç¨å¾®åŠ ç²—ä¸€ç‚¹æ›´æœ‰è´¨æ„Ÿ
            .fill('#4CAF50')
            .radius([[7, 7], [0, 0], [0, 0], [7, 7]])

          // 2. å¹³ç¨³ - è“è‰²ï¼ˆç›´è§’æ— ç¼ï¼‰
          Rect()
            .width(this.neutralWidth)
            .height(14)
            .fill('#2196F3')
          // ä¸­é—´ä¸è®¾ç½® radiusï¼Œå°±æ˜¯ç›´è§’

          // 3. å‹åŠ› - ç°è‰²ï¼ˆå³ä¾§åœ†è§’ï¼‰
          Rect()
            .width(this.negativeWidth)
            .height(14)
            .fill('#9E9E9E')
            .radius([[0, 0], [7, 7], [7, 7], [0, 0]])
        }
        .width('100%')
        .clip(true) // ç¡®ä¿å†…å®¹ä¸æº¢å‡º
        .shadow({ radius: 2, color: '#10000000', offsetY: 1 }) // ç»™æ¯”ä¾‹æ¡åŠ ä¸ªå¾®å¼±æŠ•å½±ï¼Œæ›´ç«‹ä½“

        // å›¾ä¾‹è¯´æ˜ï¼šè§£å†³â€œé»„è‰²ä¸çŸ¥é“å•¥æ„æ€â€çš„é—®é¢˜
        Row() {
          this.LegendItem('#4CAF50', 'ç§¯æ')
          this.LegendItem('#2196F3', 'å¹³ç¨³')
          this.LegendItem('#9E9E9E', 'å‹åŠ›/å†…è€—')
        }.width('100%').justifyContent(FlexAlign.SpaceBetween).margin({ top: 10 })
      }
      .width('92%')
      .padding(18)
      .backgroundColor(Color.White)
      .borderRadius(16)
      .shadow({ radius: 20, color: '#08000000' })
      .margin({ top:10,bottom: 10 })

      // --- å¯æ»šåŠ¨åŒºåŸŸï¼šAI å‘¨æŠ¥ ---
      Scroll() {
        Column() { // å®¹å™¨ 1
          Column() { // è“è‰²å¡ç‰‡å®¹å™¨ 2
            Row() {
              Image($r('app.media.ai')).width(22).height(22)
              Text(' AI æ·±åº¦æŠ¥å‘Š').fontSize(16).fontWeight(FontWeight.Bold).margin({ left: 8 })
            }.width('100%').margin({ bottom: 12 })

            if (this.isAnalyzing) {
              Column() {
                LoadingProgress().width(40).height(40).color('#007DFF')
                Text('æ­£åœ¨è§£æä½ çš„æƒ…ç»ªæµ...').fontSize(13).fontColor('#999').margin({ top: 10 })
              }
              .layoutWeight(1)
              .justifyContent(FlexAlign.Center)
              .width('100%')
            } else {
              Text(this.aiContent)
                .fontSize(15)
                .lineHeight(26)
                .fontColor('#444')
                .width('100%') // ç¡®ä¿æ–‡å­—æ’‘å¼€å®½åº¦
            }
          }
          .width('92%')
          .padding(20)
          .backgroundColor('#F5FAFF')
          .borderRadius(16)
          .border({ width: 1, color: '#E1EFFF' })
          /* ğŸ’¡ æ ¸å¿ƒä¼˜åŒ–ï¼š
             åœ¨ Scroll åµŒå¥— Column æ—¶ï¼ŒminHeight éœ€è¦å‡å» margin çš„ç©ºé—´ï¼Œ
             æˆ–è€…å¹²è„†ç›´æ¥ç”¨ layoutWeight(1) è®©å®ƒåœ¨çˆ¶å®¹å™¨é‡Œä¼¸å±•ã€‚
          */
          .constraintSize({ minHeight: '100%' })
          .justifyContent(FlexAlign.Start)
        }
        .width('100%')
        // ğŸ’¡ å…³é”®ï¼šè¿™é‡Œä¸è¦å†™æ­» height('100%')ï¼Œæœ‰æ—¶ä¼šå¯¼è‡´æ»šåŠ¨å¤±æ•ˆ
        // è€Œæ˜¯ç¡®ä¿ Column å†…éƒ¨èƒ½å¤Ÿæ’‘å¼€
        .justifyContent(FlexAlign.Start)
      }
      .layoutWeight(1)
      .width('100%')
      .margin({ top: 10, bottom: 10 })
      .padding({ bottom: 20 }) // ç»™åº•éƒ¨ç•™ä¸€ç‚¹ç‚¹å‘¼å¸ç©ºé—´
      .edgeEffect(EdgeEffect.Spring)

      // --- åº•éƒ¨ï¼šåˆ†ææŒ‰é’® ---
      Stack({ alignContent: Alignment.Bottom }) {
        Button('å¼€å§‹ AI æ·±åº¦åˆ†æ')
          .width('85%')
          .height(50)
          .margin({ bottom: 20 })
          .linearGradient({
            direction: GradientDirection.Left,
            colors: [['#007DFF', 0.0], ['#00BFFF', 1.0]]
          })
          .shadow({ radius: 10, color: '#40007DFF' })
          .enabled(!this.isAnalyzing)
          .onClick(async () => {
            await this.handleStartAnalyze()
          })
      }.width('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F1F3F5')
  }

  // è¾…åŠ©æ–¹æ³•ï¼šå›¾ä¾‹ç»„ä»¶
  @Builder LegendItem(color: string, label: string) {
    Row() {
      Circle().width(8).height(8).fill(color).margin({ right: 5 })
      Text(label).fontSize(12).fontColor('#666')
    }
  }

  // ğŸ’¡ æ˜¾å¼å®šä¹‰è¿”å›ç±»å‹ä¸º Promise<void>
  async handleStartAnalyze(): Promise<void> {
    if (this.user === null || this.user.id === undefined) {
      promptAction.showToast({ message: 'è¯·å…ˆç™»å½•åå†ä½¿ç”¨åˆ†æåŠŸèƒ½' })
      return
    }

    this.isAnalyzing = true
    const currentUserId: number = this.user.id

    try {
      // è¿™é‡Œçš„ result ä¼šè¢«è‡ªåŠ¨æ¨æ–­ä¸º string
      const result: string = await AiApi.analyzeDiary(currentUserId)
      this.aiContent = result
    } catch (err) {
      // ğŸ’¡ æ˜¾å¼æ–­è¨€ä¸º Error ç±»å‹ï¼Œè§£å†³ arkts-no-any-unknown
      const error = err as Error
      this.aiContent = `åˆ†æå‡ºé”™å•¦: ${error.message}`
      promptAction.showToast({ message: 'åˆ†æå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' })
    } finally {
      this.isAnalyzing = false
    }
  }
}