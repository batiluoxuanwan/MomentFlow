import { User } from "../model/User"
import { promptAction } from "@kit.ArkUI"
import { AiApi } from "../api/AIApi"


@Component
export struct AnalysisPage {
  @State aiContent: string = 'ç‚¹å‡»åˆ†æï¼Œè®©æˆ‘é€šè¿‡æ—¥è®°è¯»æ‡‚ä½ çš„å¿ƒæƒ…...'
  @State isAnalyzing: boolean = false
  @StorageProp('user') user: User | null = null

  build() {
    Column() {
      // å¤´éƒ¨
      Text('AI æƒ…ç»ªå‘¨æŠ¥').fontSize(24).fontWeight(FontWeight.Bold).margin(20)

      // AI å›å¤åŒºåŸŸ
      Scroll() {
        Column() {
          if (this.isAnalyzing) {
            LoadingProgress().width(40).height(40)
          } else {
            Text(this.aiContent)
              .fontSize(16)
              .lineHeight(24)
              .fontColor('#333')
              .padding(15)
          }
        }
      }
      .layoutWeight(1)
      .width('90%')
      .backgroundColor(Color.White)
      .borderRadius(15)
      .shadow({ radius: 10, color: '#10000000' })

      // è§¦å‘æŒ‰é’®
      Button('å¼€å§‹ AI æ·±åº¦åˆ†æ')
        .width('80%')
        .height(50)
        .margin(30)
        .linearGradient({
          direction: GradientDirection.Left,
          colors: [['#007DFF', 0.0], ['#00BFFF', 1.0]]
        })
        .onClick(async () => {
          await this.handleStartAnalyze()
        })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F1F3F5')
  }

  // ğŸ’¡ æ˜¾å¼å®šä¹‰è¿”å›ç±»å‹ä¸º Promise<void>
  async handleStartAnalyze(): Promise<void> {
    if (this.user === null || this.user.id === undefined) {
      promptAction.showToast({ message: 'è¯·å…ˆç™»å½•åå†ä½¿ç”¨åˆ†æåŠŸèƒ½' })
      return
    }

    this.isAnalyzing = true
    const currentUserId: number = this.user.id

    try {
      // è¿™é‡Œçš„ result ä¼šè¢«è‡ªåŠ¨æ¨æ–­ä¸º string
      const result: string = await AiApi.analyzeDiary(currentUserId)
      this.aiContent = result
    } catch (err) {
      // ğŸ’¡ æ˜¾å¼æ–­è¨€ä¸º Error ç±»å‹ï¼Œè§£å†³ arkts-no-any-unknown
      const error = err as Error
      this.aiContent = `åˆ†æå‡ºé”™å•¦: ${error.message}`
      promptAction.showToast({ message: 'åˆ†æå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' })
    } finally {
      this.isAnalyzing = false
    }
  }
}