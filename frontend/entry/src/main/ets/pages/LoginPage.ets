import router from '@ohos.router'
import promptAction from '@ohos.promptAction'
import { User } from '../model/User'
import { UserApi } from '../api/UserApi'

@Entry
@Component
struct LoginPage {
  @State account: string = ''
  //@State username: string = ''
  @State pass: string = ''
  @State isLoading: boolean = false

  async handleLogin() {
    if (!this.account || !this.pass) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥è´¦å·å¯†ç ' })
      return
    }
    this.isLoading = true;
    try {
      const res = await UserApi.login(this.account, this.pass)
      // ğŸ’¡ åªæœ‰ç¡®å®æ‹¿åˆ°äº† user å¯¹è±¡ï¼ˆä¸”åŒ…å« IDï¼‰æ‰è®¤ä¸ºç™»å½•æˆåŠŸ
      if (res && res.id !== undefined) {
        const user: User = res;
        AppStorage.setOrCreate<User>('user', user)
        promptAction.showToast({ message: 'æ¬¢è¿å›æ¥ï¼Œ' + user.username })
        router.replaceUrl({ url: 'pages/MainPage' })
      } else {
        promptAction.showToast({ message: 'ç™»å½•ä¿¡æ¯æ— æ•ˆ' })
      }
    } catch (error) {
      // ğŸ’¡ ç°åœ¨ 405 é”™è¯¯ä¼šè¿›å…¥è¿™é‡Œï¼Œè€Œä¸ä¼šè·³è½¬é¡µé¢
      const err = error as Error
      promptAction.showToast({ message: 'ç™»å½•å¤±è´¥ï¼šè´¦å·æˆ–å¯†ç é”™è¯¯' })
      console.error('Login Error:', err.message)
    }finally {
      this.isLoading = false
    }
  }

  build() {
    Column() {
      Text('æ¬¢è¿å›æ¥').fontSize(28).fontWeight(FontWeight.Bold).margin({ top: 80, bottom: 40 })

      TextInput({ placeholder: 'è¯·è¾“å…¥è´¦å·', text: this.account })
        .onChange(v => this.account = v).width('90%').height(50).margin({ bottom: 20 })

      TextInput({ placeholder: 'è¯·è¾“å…¥å¯†ç ', text: this.pass })
        .type(InputType.Password).onChange(v => this.pass = v).width('90%').height(50)

      Button(this.isLoading ? 'æ­£åœ¨ç™»å½•...' : 'ç™»å½•')
        .width('90%').height(50).margin({ top: 40 })
        .enabled(!this.isLoading)
        .onClick(() => this.handleLogin())

      Text('æ²¡æœ‰è´¦å·ï¼Ÿç«‹å³æ³¨å†Œ').fontColor('#007DFF').margin({ top: 20 })
        .onClick(() => router.pushUrl({ url: 'pages/RegisterPage' }))
    }.width('100%').height('100%').backgroundColor('#F1F3F5')
  }
}