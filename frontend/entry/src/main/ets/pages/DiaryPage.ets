import { Diary } from '../model/Diary'
import { promptAction, router } from '@kit.ArkUI'
import { DiaryApi } from '../api/DiaryApi'
import { User } from '../model/User'

@Component
export struct DiaryPage {
  // ã€å•ä¸€çœŸç†æºã€‘ç»‘å®š AppStorage
  @StorageLink('diaries') localDiaries: Diary[] = []
  @StorageProp('user') user: User | null = null
  @State isRefreshing: boolean = false

  aboutToAppear() {
    // é¦–æ¬¡è¿›å…¥åŠ è½½
    this.loadDiariesFromServer()
  }

  async loadDiariesFromServer() {
    this.isRefreshing = true
    try {
      if(this.user!=null) {
        const list = await DiaryApi.getList(this.user.id)
        // ç›´æ¥æ›´æ–° AppStorageï¼ŒlocalDiaries ä¼šè‡ªåŠ¨åŒæ­¥
        AppStorage.setOrCreate('diaries', list)
        console.info('âœ… æ•°æ®å·²åŒæ­¥åˆ°å…¨å±€ä»“åº“')
      }
      else{
        promptAction.showToast({ message: 'å½“å‰è¿˜æœªç™»å½•ï¼' })
        router.replaceUrl({ url: 'pages/LoginPage' })
      }
    } catch (e) {
      console.error('âŒ è¯·æ±‚å¤±è´¥', e)
    } finally {
      this.isRefreshing = false
    }
  }

  async loadDiariesWithDelay() {
    this.isRefreshing = true
    const startTime = Date.now()

    try {
      if(this.user!=null) {
      const list = await DiaryApi.getList(this.user.id)
      AppStorage.setOrCreate('diaries', list)
      }
      else{
        promptAction.showToast({ message: 'å½“å‰è¿˜æœªç™»å½•ï¼' })
        router.replaceUrl({ url: 'pages/LoginPage' })
      }

      // è®¡ç®—è€—æ—¶ï¼Œç¡®ä¿è‡³å°‘åœç•™ 1000ms (1ç§’)ï¼Œè®©åŠ¨ç”»æœ‰ä¸ªå±•ç¤ºè¿‡ç¨‹
      const elapsedTime = Date.now() - startTime
      const minDelay = 1000

      if (elapsedTime < minDelay) {
        setTimeout(() => {
          this.isRefreshing = false // 1ç§’åå›å¼¹
        }, minDelay - elapsedTime)
      } else {
        this.isRefreshing = false // å¦‚æœæ¥å£å¾ˆæ…¢ï¼Œç›´æ¥å›å¼¹
      }
    } catch (e) {
      console.error('åˆ·æ–°å¤±è´¥', e)
      this.isRefreshing = false
    }
  }

  build() {
    Column() {
      this.buildAppBar()

      Refresh({
        refreshing: $$this.isRefreshing,
        builder: this.myRefreshHeader() // ğŸ‘ˆ è°ƒç”¨ä¸Šé¢å®šä¹‰çš„ builder
      }) {
        List({ space: 12 }) {
          ForEach(this.localDiaries, (item: Diary) => {
            ListItem() {
              this.diaryCard(item)
            }
          }, (item: Diary) => `${item.id}_${item.title}_${item.mood}`)
        }
        .width('100%')
        .height('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
        .friction(0.8)
        .edgeEffect(EdgeEffect.Spring)
        .scrollBar(BarState.Off)
      }
      .onRefreshing(() => {
        this.loadDiariesWithDelay()
      })
      .refreshOffset(60) // ğŸ’¡ è§¦å‘è·ç¦»ç¨å¾®å¤§äº builder çš„é«˜åº¦ï¼Œæ‰‹æ„Ÿæ›´å¥½
      .pullToRefresh(true)
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F1F3F5')
  }

  @Builder
  myRefreshHeader() {
    Row() {
      LoadingProgress()
        .width(36)
        .height(36)
        .padding({top: 12})
    }
    .width('100%')
    .height(60) // ğŸ’¡ è¿™ä¸ªé«˜åº¦å°±æ˜¯ä¸‹æ‹‰å‡ºæ¥çš„ç©ºé—´é«˜åº¦ï¼Œ60-80 æ¯”è¾ƒåˆé€‚
    .justifyContent(FlexAlign.Center) // ğŸ’¡ æ°´å¹³å±…ä¸­
    .alignItems(VerticalAlign.Center) // ğŸ’¡ å‚ç›´å±…ä¸­ï¼ˆè¿™å°±æ˜¯ä½ è¦çš„æ­£ä¸­é—´ï¼‰
  }

  @Builder buildAppBar() {
    Stack() {
      Text('æˆ‘çš„æ—¥è®°').fontSize(22).fontWeight(FontWeight.Bold)
      Image($r('app.media.add'))
        .width(32).height(32)
        .position({ right: 16, top: 12 })
        .onClick(() => router.pushUrl({ url: 'pages/DiaryAdd' }))
    }
    .height(56).width('100%').backgroundColor(Color.White)
  }

  @Builder diaryCard(item: Diary) {
    Column() {
      // æ ‡é¢˜ï¼šä½¿ç”¨ maxLines å’Œ textOverflow ä¿è¯åœ¨å›ºå®šé«˜åº¦å†…ä¸æ’‘å¼€
      Text(item.title)
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333')
        .maxLines(1) // é™åˆ¶åªæœ‰ä¸€è¡Œ
        .textOverflow({ overflow: TextOverflow.Ellipsis }) // è¶…å‡ºæ˜¾ç¤ºçœç•¥å·
        .margin({ bottom: 4 })

      Text(item.mood + ' Â· ' + new Date(item.createTime).toLocaleDateString())
        .fontSize(12)
        .fontColor(Color.Gray)
    }
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({ color: '#15000000', radius: 6 })
    .width('100%')
    .height(80) // å›ºå®šé«˜åº¦ï¼Œç¡®ä¿å¡ç‰‡å¤§å°ä¸€æ¨¡ä¸€æ ·
    .justifyContent(FlexAlign.Center) // å†…å®¹å‚ç›´å±…ä¸­
    .alignItems(HorizontalAlign.Center) // æ°´å¹³å±…ä¸­ (å·¦å³å±…ä¸­)
    .onClick(() => router.pushUrl({ url: 'pages/DiaryDetail', params: { id: item.id } }))
  }
}