import { router, promptAction } from '@kit.ArkUI';
import { Diary } from '../model/Diary'
import { DiaryApi } from '../api/DiaryApi'
import { DiaryDto } from '../model/DiaryDto';
import { User } from '../model/User';

const moods: string[] = ['ðŸ˜Š å¼€å¿ƒ', 'ðŸ˜ å¹³é™', 'ðŸ˜° ç„¦è™‘', 'ðŸ˜­ éš¾è¿‡']

interface EditParams {
  id: number
}

@Entry
@Component
struct DiaryEdit {
  // 1. ã€æ ¸å¿ƒã€‘é“¾æŽ¥å…¨å±€ä»“åº“
  @StorageLink('diaries') diaries: Diary[] = []
  @StorageProp('user') user: User | null = null

  @State title: string = ''
  @State content: string = ''
  @State mood: string = 'ðŸ˜ å¹³é™'
  @State moodIndex: number = 1
  private diaryId: number = 0

  options: SelectOption[] = moods.map((item: string): SelectOption => { return { value: item } })

  aboutToAppear() {
    const params = router.getParams() as EditParams
    if (params && params.id) {
      this.diaryId = params.id
      // ä¼˜å…ˆä»Žæœ¬åœ°ä»“åº“è¯»ï¼Œæ²¡è¯»åˆ°å†æŸ¥ç½‘ç»œ
      const localDiary = this.diaries.find(item => item.id === this.diaryId)
      if (localDiary) {
        this.initState(localDiary)
      } else {
        this.loadDiary(this.diaryId)
      }
    }
  }

  async loadDiary(id: number) {
    try {
      // æ‰¾åˆ° loadDiary ä¹‹ç±»çš„æ–¹æ³•
      const res = await DiaryApi.detail(id)
      if (res !== null) {
        this.initState(res) // åªæœ‰ç¡®å®šæœ‰æ•°æ®æ‰èµ‹å€¼
      }
      // const diary = await DiaryApi.detail(id)
      // this.initState(diary)
    } catch (e) {
      promptAction.showToast({ message: 'åŠ è½½å¤±è´¥' })
    }
  }

  initState(diary: Diary) {
    this.title = diary.title
    this.content = diary.content
    this.mood = diary.mood
    this.moodIndex = moods.indexOf(diary.mood)
  }

  async saveDiary() {
    if (!this.title.trim() || !this.content.trim()) {
      promptAction.showToast({ message: 'æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º' })
      return
    }

    const updatedData: DiaryDto = {
      title: this.title,
      content: this.content,
      mood: this.mood,
      userId: this.user?.id ?? 0
    }

    try {
      const res = await DiaryApi.update(this.diaryId, updatedData)
      if (res !== null) {
        this.diaries = this.diaries.map(item => item.id === this.diaryId ? res : item)
      }
      // 1. æäº¤ç½‘ç»œæ›´æ–°
      // è¿™é‡Œçš„é€»è¾‘é€šå¸¸æ˜¯ä¿å­˜æˆåŠŸåŽåˆ·æ–°æœ¬åœ°åˆ—è¡¨
      //const result = await DiaryApi.update(this.diaryId, updatedData)
      // 2. ã€æ ¸å¿ƒã€‘æ›´æ–°å…¨å±€ Store
      // æ‰¾åˆ°æ•°ç»„ä¸­å¯¹åº”çš„é‚£æ¡æ•°æ®å¹¶æ›¿æ¢å®ƒ
      //this.diaries = this.diaries.map(item => item.id === this.diaryId ? result : item)

      promptAction.showToast({ message: 'ä¿®æ”¹æˆåŠŸ' })
      router.back()
    } catch (e) {
      promptAction.showToast({ message: 'ä¿®æ”¹å¤±è´¥' })
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å·¥å…·æ 
      Row() {
        Text('å–æ¶ˆ').fontColor(Color.Gray).onClick(() => router.back())
        Text('ä¿®æ”¹æ—¥è®°').fontSize(18).fontWeight(FontWeight.Bold)
        Text('ä¿å­˜')
          .fontColor(this.title.trim() ? '#007DFF' : '#999999')
          .fontWeight(FontWeight.Bold)
          .onClick(() => { if(this.title.trim()) this.saveDiary() })
      }
      .width('100%').justifyContent(FlexAlign.SpaceBetween).padding(16).backgroundColor(Color.White)

      Column() {
        TextInput({ placeholder: 'è¯·è¾“å…¥æ ‡é¢˜', text: this.title })
          .fontSize(20).fontWeight(FontWeight.Bold).backgroundColor(Color.Transparent)
          .onChange((v) => this.title = v)

        Divider().margin({ top: 10, bottom: 10 }).color('#F2F2F2')

        Row() {
          Text('å¿ƒæƒ…').fontColor('#666')
          Blank()
          Select(this.options)
            .selected(this.moodIndex)
            .value(this.mood)
            .onSelect((index: number) => {
              this.moodIndex = index
              this.mood = moods[index]
            })
        }.width('100%')
        .padding({left:16})

        Divider().margin({ top: 10, bottom: 10 }).color('#F2F2F2')

        TextArea({ placeholder: 'åœ¨æ­¤ä¿®æ”¹ä½ çš„æ—¥è®°...', text: this.content })
          .fontSize(16).placeholderColor('#BBB').backgroundColor(Color.Transparent)
          .layoutWeight(1)
          .onChange((v) => this.content = v)
      }
      .padding(20).backgroundColor(Color.White).borderRadius(16).margin(16).layoutWeight(1)
    }
    .height('100%').backgroundColor('#F1F3F5')
  }
}