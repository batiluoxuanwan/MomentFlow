import { router, promptAction } from '@kit.ArkUI';
import { Diary } from '../model/Diary'
import { DiaryDto } from '../model/DiaryDto'
import { DiaryApi } from '../api/DiaryApi'
import { User } from '../model/User';

const moods: string[] = ['ğŸ˜Š å¼€å¿ƒ', 'ğŸ˜ å¹³é™', 'ğŸ˜° ç„¦è™‘', 'ğŸ˜­ éš¾è¿‡']

@Entry
@Component
struct DiaryAdd {
  @State title: string = ''
  @State content: string = ''
  // è®¾ç½®é»˜è®¤å€¼ï¼Œé˜²æ­¢ Select ç»„ä»¶åˆå§‹æ˜¾ç¤ºä¸ºç©º
  @State mood: string = moods[1]
  @State moodIndex: number = 1

  // ä½¿ç”¨ StorageLinkï¼Œè¿™æ ·æˆ‘ä»¬åœ¨ addDiary æ—¶ç›´æ¥ä¿®æ”¹å®ƒï¼Œé¦–é¡µä¼šè‡ªåŠ¨å˜
  @StorageLink('diaries') diaries: Diary[] = []
  @StorageProp('user') user: User | null = null

  options: SelectOption[] = moods.map((item: string): SelectOption => {
    return { value: item }
  })

  async saveDiary() {
    if (!this.title.trim() || !this.content.trim()) {
      promptAction.showToast({ message: 'æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º' })
      return
    }

    const newDiaryDto: DiaryDto = {
      title: this.title,
      content: this.content,
      mood: this.mood,
      userId: this.user?.id ?? 0
    }

    try {
      const res = await DiaryApi.create(newDiaryDto)
      if (res !== null) {
        // è¿™é‡ŒåŸå…ˆå¯èƒ½æ˜¯æŠŠ res å¡è¿›åˆ—è¡¨æˆ–è€…è·³è½¬
        this.diaries = [res, ...this.diaries]
      }
      // 1. å‘é€åˆ°æœåŠ¡å™¨
      //const result = await DiaryApi.create(newDiaryDto)
      // 2. ã€å…³é”®ï¼šåŒæ­¥æœ¬åœ° Storeã€‘
      // ç›´æ¥é€šè¿‡ StorageLink æ›´æ–°å…¨å±€æ•°ç»„ï¼Œè§¦å‘é¦–é¡µè‡ªåŠ¨åˆ·æ–°
      // ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦ [...] ç¡®ä¿è§¦å‘ ArkUI çš„çŠ¶æ€ç›‘å¬
      //this.diaries = [result, ...this.diaries]

      promptAction.showToast({ message: 'æ–°å¢æˆåŠŸ' })

      // 3. è¿”å›ä¸Šä¸€é¡µ
      router.back()
    } catch (e) {
      console.error('âŒ æ–°å¢å¤±è´¥', e)
      promptAction.showToast({ message: 'å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ' })
    }
  }

  build() {
    Column() {
      // è‡ªå®šä¹‰é¡¶éƒ¨æ 
      Row() {
        Text('å–æ¶ˆ').fontColor(Color.Gray).onClick(() => router.back())
        Text('å†™æ—¥è®°').fontSize(18).fontWeight(FontWeight.Bold)
        Text('å®Œæˆ')
          .fontColor(this.title.trim() ? '#007DFF' : '#999999')
          .fontWeight(FontWeight.Medium)
          .onClick(() => {
            if(this.title.trim()) this.saveDiary()
          })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .padding(16)
      .backgroundColor(Color.White)

      // è¾“å…¥åŒºåŸŸ
      Column() {
        TextInput({ placeholder: 'è¯·è¾“å…¥æ ‡é¢˜', text: this.title })
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .placeholderColor('#999')
          .backgroundColor(Color.Transparent)
          .onChange((value: string) => this.title = value)
          .padding({ top: 20, bottom: 20 })

        Divider().color('#F2F2F2').strokeWidth(1)

        Row() {
          Text('å½“å‰å¿ƒæƒ…').fontSize(16).fontColor('#666')
          Blank()
          Select(this.options)
            .selected(this.moodIndex)
            .value(this.mood)
            .font({ size: 16 })
            .onSelect((index: number) => {
              this.moodIndex = index
              this.mood = moods[index]
            })
        }
        .width('100%')
        .padding({ top: 10, bottom: 10,left: 16 })

        Divider().color('#F2F2F2').strokeWidth(1)

        TextArea({ placeholder: 'è®°å½•ä¸‹è¿™ä¸€åˆ»çš„æƒ³æ³•...', text: this.content })
          .placeholderColor('#BBB')
          .fontSize(16)
          .layoutWeight(1) // è®©å†…å®¹åŒºåŸŸå æ»¡å‰©ä½™ç©ºé—´
          .backgroundColor(Color.Transparent)
          .padding({ top: 20 })
          .onChange((value: string) => this.content = value)
      }
      .padding(20)
      .backgroundColor(Color.White)
      .borderRadius(16)
      .margin(16)
      .layoutWeight(1) // æ•´ä½“å®¹å™¨å æ»¡ï¼Œä»¥ä¾¿ TextArea ä¼¸ç¼©
    }
    .height('100%')
    .backgroundColor('#F1F3F5')
  }
}