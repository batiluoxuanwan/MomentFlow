import router from '@ohos.router'
import promptAction from '@ohos.promptAction'
import { UserApi } from '../api/UserApi'
import { User } from '../model/User'

@Entry
@Component
struct SecurityPage {
  @State oldPass: string = ''
  @State newPass: string = ''
  @State confirmPass: string = ''

  @StorageProp('user') user: User | null = null

  build() {
    Column() {
      Row() {
        Text('è¿”å›').onClick(() => router.back())
        Text('ä¿®æ”¹å¯†ç ').fontSize(18).fontWeight(FontWeight.Bold).layoutWeight(1).textAlign(TextAlign.Center).margin({ right: 40 })
      }.width('100%').padding(16)

      Column() {
        TextInput({ placeholder: 'åŸå¯†ç ' }).type(InputType.Password).onChange(v => this.oldPass = v).height(60)
        Divider().color('#F2F2F2')
        TextInput({ placeholder: 'æ–°å¯†ç ' }).type(InputType.Password).onChange(v => this.newPass = v).height(60)
        Divider().color('#F2F2F2')
        TextInput({ placeholder: 'ç¡®è®¤æ–°å¯†ç ' }).type(InputType.Password).onChange(v => this.confirmPass = v).height(60)
      }
      .backgroundColor(Color.White).borderRadius(12).margin(16).padding({ left: 12, right: 12 })

      Button('ç¡®è®¤æäº¤').width('90%').height(50).margin({ top: 40 })
        .onClick(async () => {
          if (this.newPass !== this.confirmPass) {
            promptAction.showToast({ message: 'ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´' })
            return
          }
          // ğŸ’¡ 2. è°ƒç”¨æ¥å£å‘èµ·ä¿®æ”¹å¯†ç è¯·æ±‚
          if (this.user === null || this.user.id === undefined) {
            promptAction.showToast({ message: 'ç”¨æˆ·ç™»å½•å·²å¤±æ•ˆ' })
            return
          }

          // ğŸ’¡ æ­¤æ—¶ ArkTS çŸ¥é“ this.user.id ä¸€å®šæ˜¯ number ç±»å‹
          const userId: number = this.user.id
          try {
            // è°ƒç”¨å¸¦ userId çš„ç‰ˆæœ¬
            const success = await UserApi.updatePassword(userId, this.oldPass, this.newPass)

            if (success) {
              promptAction.showToast({ message: 'å¯†ç ä¿®æ”¹æˆåŠŸ' })
              // ä¿®æ”¹æˆåŠŸåé€šå¸¸å»ºè®®ç”¨æˆ·é‡æ–°ç™»å½•
              router.back()
            }
          } catch (error) {
            // ğŸ’¡ é‡ç‚¹ï¼šè¿™é‡Œçš„ error.message ä¼šæ•è·åç«¯ R.error("åŸå¯†ç é”™è¯¯") é‡Œçš„æç¤ºå†…å®¹
            const err = error as Error
            promptAction.showToast({ message: err.message })
          }
        })
    }.width('100%').height('100%').backgroundColor('#F1F3F5')
  }
}