import router from '@ohos.router'
import promptAction from '@ohos.promptAction'
import picker from '@ohos.file.picker';
import { User } from '../model/User'
import { UserApi } from '../api/UserApi'
import { UserDto } from '../model/UserDto'

@Entry
@Component
struct EditProfilePage {
  @StorageLink('user') user: User | null = null

  @State tempName: string = ''
  @State tempSign: string = ''
  @State tempAvatar: string = ''
  @State tempEmail: string = ''
  @State isLoading: boolean = false
  @State avatarUri: string = '' // æœ¬åœ°ä¸´æ—¶æ˜¾ç¤ºçš„å›¾ç‰‡è·¯å¾„

  // 1. å”¤èµ·ç›¸å†Œé€‰å¤´åƒ
  async selectAvatar() {
    const photoPicker = new picker.PhotoViewPicker();
    const result = await photoPicker.select({
      MIMEType: picker.PhotoViewMIMETypes.IMAGE_TYPE,
      maxSelectNumber: 1
    });

    if (result.photoUris.length > 0) {
      const localUri = result.photoUris[0];
      this.tempAvatar = localUri; // ðŸ’¡ é‡ç‚¹ï¼šé€‰å®Œç«‹åˆ»åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºæœ¬åœ°å›¾ç‰‡ï¼Œä¸è¦ç­‰ä¸Šä¼ 
      this.uploadAvatar(localUri);
    }
  }
  // 2. ä¸Šä¼ å¹¶åŒæ­¥åˆ° User å¯¹è±¡
  async uploadAvatar(uri: string) {
    if (this.user) {
      try {
        // 1. èŽ·å–ä¸Šä¼ åŽçš„ URL
        const remoteUrl: string | null = await UserApi.uploadAvatar(uri);

        // ðŸ’¡ æ ¸å¿ƒä¿®å¤ï¼šåªæœ‰å½“ remoteUrl ä¸ä¸º null æ—¶æ‰è¿›è¡Œèµ‹å€¼
        if (remoteUrl !== null) {
          // æ›´æ–°æœ¬åœ°é¢„è§ˆï¼ˆå¦‚æžœæœ‰ tempAvatar çŠ¶æ€ï¼‰
          this.tempAvatar = remoteUrl;

          // æ›´æ–°å…¨å±€ User å¯¹è±¡ä¸­çš„å¤´åƒåœ°å€
          // åœ¨ä½ çš„ä»£ç ä¸­ä¿®æ”¹è¿™ä¸€è¡Œ
          this.user.avatar = remoteUrl + '?t=' + new Date().getTime();

          // 2. å°†æ•´ä¸ªç”¨æˆ·ä¿¡æ¯åŒæ­¥åˆ°åŽç«¯æ•°æ®åº“
          // æ³¨æ„ï¼šç¡®ä¿ä½ çš„ UserApi ä¸­æœ‰ update è¿™ä¸ªæ–¹æ³•ï¼Œæˆ–è€…ä½¿ç”¨ä½ å®šä¹‰çš„ updateProfile
          await UserApi.update(this.user.id, {
            username: this.user.username,
            avatar: this.user.avatar,
            signature: this.user.signature,
            email: this.user.email
          });

          promptAction.showToast({ message: 'å¤´åƒä¿®æ”¹æˆåŠŸ' });
        } else {
          // å¤„ç†è¿”å›žä¸º null çš„æƒ…å†µ
          promptAction.showToast({ message: 'ä¸Šä¼ å¤±è´¥ï¼šæœªèŽ·å–åˆ°å›¾ç‰‡åœ°å€' });
        }
      } catch (e) {
        const error = e as Error;
        promptAction.showToast({ message: 'æ“ä½œå¤±è´¥: ' + error.message });
      }
    }
  }

  aboutToAppear() {
    // ðŸ’¡ åˆå§‹åŒ–æ‰€æœ‰å­—æ®µï¼Œç¡®ä¿ä¿å­˜æ—¶ä¸ä¸ºç©º
    this.tempName = this.user?.username ?? ''
    this.tempSign = this.user?.signature ?? ''
    this.tempAvatar = this.user?.avatar ?? ''
    this.tempEmail = this.user?.email ?? ''
  }

  async handleSave() {
    // ðŸ’¡ å¢žåŠ å®‰å…¨æ ¡éªŒï¼šå¿…é¡»æœ‰ç™»å½•ç”¨æˆ·ä¸”æœ‰ ID
    if (!this.user || this.user.id === undefined) {
      promptAction.showToast({ message: 'ç”¨æˆ·ä¿¡æ¯å¼‚å¸¸' })
      return
    }

    if (!this.tempName.trim()) {
      promptAction.showToast({ message: 'ç”¨æˆ·åä¸èƒ½ä¸ºç©º' })
      return
    }

    this.isLoading = true
    try {
      // 1. æž„é€  DTO å¯¹è±¡
      const updatedDto: UserDto = {
        username: this.tempName,
        signature: this.tempSign,
        avatar: this.tempAvatar,
        email: this.tempEmail
      }

      // 2. è°ƒç”¨åŽç«¯æŽ¥å£ï¼šä¼ å…¥ id å’Œ dto
      // ðŸ’¡ æ³¨æ„ï¼šè¿™é‡Œå¿…é¡»ä¼ ä¸¤ä¸ªå‚æ•°ï¼Œå¯¹åº” UserApi.update(id: number, userDto: UserDto)
      const res = await UserApi.update(this.user.id, updatedDto)

      if (res) {
        this.user = res
        promptAction.showToast({ message: 'ä¿®æ”¹æˆåŠŸ' })
        router.back()
      }
    } catch (error) {
      const err = error as Error
      promptAction.showToast({ message: err.message || 'ä¿å­˜å¤±è´¥' })
    } finally {
      this.isLoading = false
    }
  }

  build() {
    Column() {
      // å¤´éƒ¨å¯¼èˆª
      Row() {
        Text('å–æ¶ˆ').onClick(() => router.back())
        Text('ç¼–è¾‘èµ„æ–™').fontSize(18).fontWeight(FontWeight.Bold)

        if (this.isLoading) {
          LoadingProgress().width(24).height(24)
        } else {
          Text('ä¿å­˜').fontColor('#007DFF')
            .onClick(() => this.handleSave())
        }
      }.width('100%').justifyContent(FlexAlign.SpaceBetween).padding(16)

      // å¤´åƒç¼–è¾‘
      Image(this.tempAvatar || $r('app.media.user_placeholder'))
        .width(80).height(80).borderRadius(40).margin(30)
        .onClick(() => {
          this.selectAvatar() // å”¤èµ·å›¾åº“
        })
      Text('ç‚¹å‡»æ›´æ¢å¤´åƒ').fontSize(14).fontColor('#007DFF').margin({ bottom: 30 })
        .onClick(() => {
          this.selectAvatar() // å”¤èµ·å›¾åº“
        })

      // è¾“å…¥è¡¨å•
      Column() {
        // ç”¨æˆ·å
        Row() {
          Text('ç”¨æˆ·å').width(80).fontSize(16)
          TextInput({ text: this.tempName })
            .onChange(v => this.tempName = v)
            .layoutWeight(1)
            .backgroundColor(Color.Transparent)
            .textAlign(TextAlign.End)
        }.height(60).width('100%')

        Divider().color('#F1F3F5').margin({ left: 80 })

        // ä¸ªæ€§ç­¾å
        Row() {
          Text('ä¸ªæ€§ç­¾å').width(80).fontSize(16)
          TextInput({ text: this.tempSign })
            .onChange(v => this.tempSign = v)
            .layoutWeight(1)
            .backgroundColor(Color.Transparent)
            .textAlign(TextAlign.End)
        }.height(60).width('100%')

        /* --- ðŸ’¡ é‚®ç®±ä¿®æ”¹åŠŸèƒ½æš‚æ—¶æ³¨é‡Š ---
        Divider().color('#F1F3F5').margin({ left: 80 })
        Row() {
          Text('é‚®ç®±').width(80).fontSize(16)
          TextInput({ text: this.tempEmail })
            .onChange(v => this.tempEmail = v)
            .layoutWeight(1)
            .backgroundColor(Color.Transparent)
            .textAlign(TextAlign.End)
        }.height(60).width('100%')
        ------------------------------ */
      }
      .backgroundColor(Color.White)
      .padding({ left: 16, right: 16 })
      .borderRadius(12)
      .margin({ left: 16, right: 16 })

    }.width('100%').height('100%').backgroundColor('#F1F3F5')
  }
}