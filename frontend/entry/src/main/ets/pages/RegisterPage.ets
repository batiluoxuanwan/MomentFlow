import router from '@ohos.router'
import promptAction from '@ohos.promptAction'
import { UserApi } from '../api/UserApi'
import { User } from '../model/User'

@Entry
@Component
struct RegisterPage {
  @State username: string = ''
  @State email: string = ''
  @State verifyCode: string = ''
  @State password: string = ''
  @State confirmPass: string = ''

  // éªŒè¯ç ç›¸å…³çŠ¶æ€
  @State isCountDowning: boolean = false
  @State second: number = 60
  private timerId: number = -1
  @State isLoading: boolean = false

  // é”€æ¯é¡µé¢æ—¶æ¸…ç†å®šæ—¶å™¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
  aboutToDisappear() {
    if (this.timerId !== -1) {
      clearInterval(this.timerId)
    }
  }

  // éªŒè¯ç å€’è®¡æ—¶é€»è¾‘
  // éªŒè¯ç å€’è®¡æ—¶é€»è¾‘
  async startCountDown() {
    if (this.isCountDowning) return

    if (!this.email.includes('@')) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±åœ°å€' })
      return
    }
    // 1. ğŸ’¡ å…ˆå¯åŠ¨æœ¬åœ°å€’è®¡æ—¶é€»è¾‘
    this.isCountDowning = true
    this.second = 60
    this.timerId = setInterval(() => {
      if (this.second > 1) {
        this.second--
      } else {
        this.stopCountDown() // æ—¶é—´åˆ°äº†è‡ªåŠ¨åœæ­¢
      }
    }, 1000)
    // 2. ğŸ’¡ å†å‘èµ·ç½‘ç»œè¯·æ±‚
    try {
      const success = await UserApi.sendEmailCode(this.email)
      if (success) {
        promptAction.showToast({ message: 'éªŒè¯ç å·²å‘é€è‡³é‚®ç®±' })
      } else {
        // å¦‚æœåç«¯è¿”å›å¤±è´¥ï¼Œé‡ç½®çŠ¶æ€
        this.stopCountDown()
        promptAction.showToast({ message: 'å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥é‚®ç®±æ˜¯å¦æ­£ç¡®' })
      }
    } catch (e) {
      // æ•è·åˆšæ‰é‚£ä¸ª JSON parse error æˆ–è€…ç½‘ç»œé”™è¯¯
      this.stopCountDown()
      promptAction.showToast({ message: 'æœåŠ¡å™¨å¼€å°å·®äº†ï¼Œè¯·æ£€æŸ¥åç«¯' })
    }
  }

  stopCountDown() {
    clearInterval(this.timerId)
    this.timerId = -1
    this.isCountDowning = false
    this.second = 60
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨è¿”å›
      Row() {
        Image($r('sys.media.ohos_ic_public_arrow_left'))
          .width(24).height(24)
          .onClick(() => router.back())
      }.width('100%').padding(20)

      Text('åˆ›å»ºæ–°è´¦å·').fontSize(28).fontWeight(FontWeight.Bold).margin({ top: 10, bottom: 30 })

      // 2. æ³¨å†Œè¡¨å•
      Column({ space: 12 }) {
        TextInput({ placeholder: 'ç”¨æˆ·å', text: this.username })
          .onChange(v => this.username = v).width('90%').height(50)

        TextInput({ placeholder: 'é‚®ç®±åœ°å€', text: this.email })
          .onChange(v => this.email = v).width('90%').height(50)

        // --- éªŒè¯ç è¾“å…¥è¡Œ ---
        Row() {
          TextInput({ placeholder: 'éªŒè¯ç ' })
            .onChange(v => this.verifyCode = v)
            .layoutWeight(1).height(50)

          Button(this.isCountDowning ? `${this.second}s` : 'è·å–éªŒè¯ç ')
            .fontSize(10)
            .height(40)
            .margin({ left: 10 })
            .width(100)
            .backgroundColor(this.isCountDowning ? '#F2F2F2' : '#007DFF')
            .fontColor(this.isCountDowning ? '#999' : Color.White)
            .enabled(!this.isCountDowning)
            .onClick(() => this.startCountDown())
        }.width('90%')

        TextInput({ placeholder: 'è®¾ç½®å¯†ç ' })
          .type(InputType.Password).onChange(v => this.password = v).width('90%').height(50)

        TextInput({ placeholder: 'ç¡®è®¤å¯†ç ' })
          .type(InputType.Password).onChange(v => this.confirmPass = v).width('90%').height(50)
      }

      // 3. æ³¨å†ŒæŒ‰é’®
      Button(this.isLoading ? 'æ­£åœ¨å¤„ç†...' : 'ç«‹å³æ³¨å†Œ')
        .width('90%').height(50).margin({ top: 40 })
        .enabled(!this.isLoading)
        .onClick(() => this.handleRegister())

      Text('æ³¨å†Œå³ä»£è¡¨åŒæ„ã€Šç”¨æˆ·åè®®ã€‹').fontSize(12).fontColor('#999').margin({ top: 15 })

    }.width('100%').height('100%').backgroundColor('#F1F3F5')
  }

  async handleRegister() {
    if (!this.username || !this.email || !this.verifyCode || !this.password) {
      promptAction.showToast({ message: 'è¯·å®Œæ•´å¡«å†™æ³¨å†Œä¿¡æ¯' })
      return
    }

    if (this.password !== this.confirmPass) {
      promptAction.showToast({ message: 'ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´' })
      return
    }

    this.isLoading = true

    // æ„é€ è¯·æ±‚æ•°æ®
    const newUser: User = {
      id: 0,
      username: this.username,
      email: this.email,
      password: this.password, // åç«¯æ ¡éªŒéªŒè¯ç åå¤„ç†å¯†ç åŠ å¯†
      signature: 'è®°å½•ç¾å¥½ç”Ÿæ´»',
      avatar: ''
    }

    try {
      const res = await UserApi.register(newUser, this.verifyCode)
      if (res) {
        // æ³¨å†ŒæˆåŠŸ
        AppStorage.setOrCreate('user', res)
        promptAction.showToast({ message: 'æ³¨å†ŒæˆåŠŸï¼' })
        router.replaceUrl({ url: 'pages/LoginPage' })
      }
    } catch (e) {
      // ğŸ’¡ æ”¹è¿›ï¼šå°è¯•è·å–åç«¯è¿”å›çš„å…·ä½“é”™è¯¯æ¶ˆæ¯
      // æ¯”å¦‚åç«¯è¿”å› 400 æ—¶çš„ "è¯¥é‚®ç®±å·²è¢«æ³¨å†Œ" æˆ– "éªŒè¯ç é”™è¯¯"
      const errorMsg:string = e.message || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åå†è¯•'
      promptAction.showToast({ message: errorMsg })
      console.error('æ³¨å†Œç¯èŠ‚å‡ºé”™:', errorMsg)
    } finally {
      this.isLoading = false
    }
  }
}