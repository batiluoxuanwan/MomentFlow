import { Diary } from '../model/Diary'
import { User } from '../model/User' // ğŸ’¡ è®°å¾—å¯¼å…¥ User æ¨¡å‹
import { promptAction, router } from '@kit.ArkUI'
import { common } from '@kit.AbilityKit'

@Component
export struct MinePage {
  @StorageProp('diaries') diaries: Diary[] = []
  // ğŸ’¡ è·å–å…¨å±€å­˜å‚¨çš„ç™»å½•ç”¨æˆ·ä¿¡æ¯
  @StorageProp('user') user: User | null = null

  aboutToAppear() {
    // ğŸ’¡ æ‰“å°ä¸€ä¸‹ï¼Œçœ‹çœ‹å…¨å±€å­˜å‚¨é‡Œç°åœ¨åˆ°åº•å­˜äº†ä»€ä¹ˆ
    const globalUser = AppStorage.get<User>('user')
    console.info('DEBUG_MINE: å½“å‰å…¨å±€å­˜å‚¨ä¸­çš„ç”¨æˆ·ä¿¡æ¯ä¸º: ' + JSON.stringify(globalUser))

    // å¦‚æœå…¨å±€æœ‰ï¼Œä½†æœ¬åœ°æ²¡æ‹¿åˆ°ï¼Œå¼ºåˆ¶åŒæ­¥ä¸€æ¬¡
    if (globalUser && !this.user) {
      this.user = globalUser
    }
  }

  getTotalWords(): string {
    if (!this.diaries || this.diaries.length === 0) {
      return '0';
    }

    let total = 0;
    this.diaries.forEach(diary => {
      // ç´¯è®¡æ¯ç¯‡æ—¥è®°å†…å®¹çš„é•¿åº¦
      if (diary.content) {
        total += diary.content.length;
      }
    });

    // ğŸ’¡ æ¼”ç¤ºå°æŠ€å·§ï¼šå¦‚æœå­—æ•°å¾ˆå¤šï¼Œæ˜¾ç¤ºä¸º k (åƒ) ç»“å°¾ï¼Œæ˜¾å¾—æ›´é«˜çº§
    if (total >= 1000) {
      return (total / 1000).toFixed(1) + 'k';
    }
    return total.toString();
  }

  @Builder
  SettingItem(icon: Resource, title: string, rightText: string = '', action: () => void = () => {}) {
    Row() {
      Image(icon).width(22).height(22).margin({ right: 12 })
      Text(title).fontSize(16).fontColor('#333')
      Blank()
      Text(rightText).fontSize(14).fontColor('#999').margin({ right: 4 })
      Image($r('sys.media.ohos_ic_public_arrow_right')).width(18).height(18).fillColor('#CCC')
    }
    .width('100%').height(56).padding({ left: 16, right: 16 })
    .backgroundColor(Color.White)
    .onClick(() => action())
  }

  build() {
    Column() {
      // 1. å¤´éƒ¨å¡ç‰‡
      Column() {
        Row() {
          // ğŸ’¡ å¤´åƒé€‚é…ï¼šå¦‚æœç”¨æˆ·æ²¡æœ‰å¤´åƒï¼Œä½¿ç”¨é»˜è®¤å ä½å›¾
          Image(this.user?.avatar || $r('app.media.user_placeholder'))
            .width(70).height(70).borderRadius(35).margin({ right: 16 })

          Column() {
            // ğŸ’¡ æ›¿æ¢ï¼šä½¿ç”¨çœŸå®ç”¨æˆ·å
            Text(this.user?.username || 'æœªç™»å½•ç”¨æˆ·')
              .fontSize(20).fontWeight(FontWeight.Bold).fontColor(Color.White)

            // ğŸ’¡ æ›¿æ¢ï¼šä½¿ç”¨çœŸå®ç­¾å
            Text(this.user?.signature || 'æš‚æ— ä¸ªæ€§ç­¾å')
              .fontSize(14).fontColor('#CCFFFFFF').margin({ top: 4 })
          }.alignItems(HorizontalAlign.Start)
        }
        .width('100%').padding({ top: 40, bottom: 30, left: 24 })

        Row() {
          Column() {
            Text(this.diaries.length.toString()).fontSize(18).fontWeight(FontWeight.Bold).fontColor(Color.White)
            Text('æ—¥è®°ç¯‡æ•°').fontSize(12).fontColor('#CCFFFFFF')
          }.layoutWeight(1)
          Divider().vertical(true).height(20).color('#40FFFFFF')
          Column() {
            Text(this.getTotalWords()).fontSize(18).fontWeight(FontWeight.Bold).fontColor(Color.White)
            Text('æ€»å­—æ•°').fontSize(12).fontColor('#CCFFFFFF')
          }.layoutWeight(1)
        }.padding({ bottom: 20 })
      }
      .backgroundColor('#007DFF').borderRadius({ bottomLeft: 24, bottomRight: 24 })

      // 2. åˆ—è¡¨
      List() {
        ListItem() {
          Column() {
            this.SettingItem($r('app.media.edit'), 'ç¼–è¾‘èµ„æ–™',"",() => {router.pushUrl({ url: 'pages/EditProfilePage' })})
            Divider().margin({ left: 50, right: 16 }).color('#F2F2F2')
            this.SettingItem($r('app.media.security'), 'è´¦å·å®‰å…¨',"",() => router.pushUrl({ url: 'pages/SecurityPage' }))
          }.backgroundColor(Color.White).borderRadius(12).margin({ top: 20 }).clip(true)
        }
        ListItem() {
          Column() {
            this.SettingItem($r('app.media.about'), 'å…³äºæˆ‘ä»¬', 'v1.0.0',() => {
              router.pushUrl({
                url: 'pages/WebPage',
                params: {
                  // url: 'https://github.com/batiluoxuanwan/MomentFlow', // å¯†ç çš„æ‰“ä¸å¼€
                  url: 'https://gitee.com/GleeDean/MomentFlow',
                  title: 'é¡¹ç›®æºç '
                }
              })
            })
          }.backgroundColor(Color.White).borderRadius(12).margin({ top: 12 }).clip(true)
        }
        ListItem() {
          Button('é€€å‡ºç™»å½•').width('100%').height(50).backgroundColor(Color.White)
            .fontColor(Color.Red).margin({ top: 30 }).borderRadius(12)
            .onClick(() => {
              // 1. æ¸…ç©ºå…¨å±€çŠ¶æ€
              AppStorage.setOrCreate('user', null)
              AppStorage.setOrCreate('diaries', [])

              // 2. è·³è½¬å›ç™»å½•é¡µ
              router.replaceUrl({ url: 'pages/LoginPage' })

              promptAction.showToast({ message: 'å·²é€€å‡ºç™»å½•' })
            })
        }
      }
      .layoutWeight(1).padding({ left: 16, right: 16 })
    }
    .width('100%').height('100%').backgroundColor('#F1F3F5')
  }
}