import http from '@ohos.net.http';
import { R } from '../model/R';

export function request<T>(url: string, options: http.HttpRequestOptions): Promise<T | null> {
  return new Promise<T | null>((resolve, reject) => {
    const httpRequest = http.createHttp();

    httpRequest.request(url, options, (err: Error, data: http.HttpResponse) => {
      httpRequest.destroy();

      // 1. ç½‘ç»œå±‚æ ¡éªŒ (HTTP çŠ¶æ€ç )
      if (err || data.responseCode !== 200) {
        reject(new Error("ç½‘ç»œè¿æ¥å¼‚å¸¸"));
        return;
      }

      try {
        // 2. è¿™é‡Œçš„ T æ˜¯ä½ åœ¨è°ƒç”¨å¤„ä¼ å…¥çš„ç±»å‹ï¼ˆå¦‚ User æˆ– stringï¼‰
        const result: R<T> = JSON.parse(data.result as string) as R<T>;

        // 3. ä¸šåŠ¡å±‚æ ¡éªŒ (åç«¯ R.code)a
        if (result.code === 200) {
          // ğŸ’¡ ä¸šåŠ¡æˆåŠŸï¼Œç›´æ¥æŠŠé‡Œé¢çš„ data åç»™ Service å±‚
          resolve(result.data);
        } else {
          // ğŸ’¡ ä¸šåŠ¡å¤±è´¥ï¼ˆå¦‚ï¼šåŸå¯†ç é”™è¯¯ï¼‰ï¼Œå°†åç«¯ç»™çš„æç¤ºè¯­å°è£…è¿› Error æŠ›å‡º
          reject(new Error(result.msg));
        }
      } catch (e) {
        reject(new Error("æ•°æ®è§£æå¤±è´¥"));
      }
    });
  });
}