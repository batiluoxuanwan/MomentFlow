import fs from '@ohos.file.fs';
import { http } from '@kit.NetworkKit';
import { common } from '@kit.AbilityKit';
import { promptAction } from '@kit.ArkUI';
import { systemShare } from '@kit.ShareKit';
import { fileUri } from '@kit.CoreFileKit'; // ğŸ’¡ å¯¼å…¥æ–‡ä»¶ URI è½¬æ¢å·¥å…·

export class ExportUtil {
  static async downloadAndSharePdf(diaryId: number, context: common.UIAbilityContext): Promise<void> {
    const httpRequest: http.HttpRequest = http.createHttp();

    try {
      // 1. è·å– PDF æ•°æ®
      const res: http.HttpResponse = await httpRequest.request(
        `http://10.0.2.2:8080/api/diary/export/pdf/${diaryId}`,
        {
          method: http.RequestMethod.GET,
          expectDataType: http.HttpDataType.ARRAY_BUFFER
        }
      );

      if (res.result instanceof ArrayBuffer) {
        const pdfData: ArrayBuffer = res.result;

        // 2. åœ¨æ²™ç®±ç”Ÿæˆæ–‡ä»¶ï¼ˆæ–‡ä»¶åå†™æ­»ï¼Œè§£å†³æ‰‹åŠ¨è¾“å…¥çƒ¦æ¼ï¼‰
        const fileName = `Diary_Export_${diaryId}.pdf`;
        const filePath = `${context.filesDir}/${fileName}`; // ä½¿ç”¨ filesDir æ›´ç¨³å¦¥

        // 3. å†™å…¥æ–‡ä»¶
        const file = fs.openSync(filePath, fs.OpenMode.READ_WRITE | fs.OpenMode.CREATE | fs.OpenMode.TRUNC);
        fs.writeSync(file.fd, pdfData);
        fs.closeSync(file);

        // 4. ğŸ’¡ å°†è·¯å¾„è½¬æ¢ä¸ºç³»ç»Ÿåˆ†äº«å¯è¯†åˆ«çš„ URI
        const uriString = fileUri.getUriFromPath(filePath);

        // 5. æ„é€ åˆ†äº«æ•°æ®
        const data: systemShare.SharedData = new systemShare.SharedData({
          utd: 'com.adobe.pdf',
          uri: uriString,
          title: fileName
        });

        // 6. ğŸ’¡ ä¿®æ­£è°ƒç”¨ï¼šå»æ‰ä¸æ”¯æŒçš„ preview å±æ€§
        const controller: systemShare.ShareController = new systemShare.ShareController(data);

        // å¦‚æœè¿™é‡Œè¿˜æŠ¥é”™ï¼Œå°è¯•ç›´æ¥è°ƒç”¨ controller.show(context) è€Œä¸ä¼ ç¬¬äºŒä¸ªå‚æ•°
        controller.show(context, {
          // è¿™é‡Œä¿æŒç©ºå¯¹è±¡ï¼Œæˆ–æ ¹æ® DevEco æç¤ºæ·»åŠ å¯ç”¨å±æ€§ï¼ˆå¦‚ selectionModeï¼‰
        });

        promptAction.showToast({ message: 'å¯¼å‡ºæˆåŠŸï¼Œè¯·é€‰æ‹©åˆ†äº«/ä¿å­˜æ–¹å¼' });
      }
    } catch (err) {
      const error: Error = err as Error;
      promptAction.showToast({ message: 'æ“ä½œå¤±è´¥: ' + error.message });
      console.error('Share Error:', error.message);
    } finally {
      httpRequest.destroy();
    }
  }
}